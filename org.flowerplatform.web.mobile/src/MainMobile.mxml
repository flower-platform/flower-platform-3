<?xml version="1.0" encoding="utf-8"?>
<!---
@author Cristian Spiescu
-->
<s:Application applicationDPI="160" creationComplete="creationCompleteHandler()"
	xmlns:fx="http://ns.adobe.com/mxml/2009" 
	xmlns:s="library://ns.adobe.com/flex/spark" xmlns:mobile="org.flowerplatform.web.mobile.*">
	<fx:Script>
		<![CDATA[
			import mx.core.FlexGlobals;
			
			import org.flowerplatform.web.git.common.GitCommonPlugin;
			import org.flowerplatform.blazeds.BridgeEvent;
			import org.flowerplatform.communication.CommunicationPlugin;
			import org.flowerplatform.flexutil.FlexUtilGlobals;
			import org.flowerplatform.flexutil.FlowerLoaderUtil;
			import org.flowerplatform.flexutil.plugin.AbstractFlexPlugin;
			import org.flowerplatform.flexutil.plugin.FlexPluginDescriptor;
			import org.flowerplatform.web.common.WebCommonPlugin;
			import org.flowerplatform.web.mobile.SplitView;
			import org.flowerplatform.web.mobile.popup.WrapperViewPopupHandlerFactory;
			
			public static function get mainApp():MainMobile {
				return MainMobile(FlexGlobals.topLevelApplication);
			}
			
			/**
			 * We need to inject the plugin URL, so that the plugins can find resources and messages.
			 */
			private function setDescriptorWithUrl(plugin:AbstractFlexPlugin, url:String):AbstractFlexPlugin {
				var descriptor:FlexPluginDescriptor = new FlexPluginDescriptor();
				descriptor.url = url;
				plugin.flexPluginDescriptor = descriptor;
				return plugin;
			}
			
			private var plugins:Array = [
				setDescriptorWithUrl(new CommunicationPlugin(), 'servlet/public-resources/org.flowerplatform.communication/org.flowerplatform.communication.swc|library.swf'), 
				setDescriptorWithUrl(new WebCommonPlugin(), 'servlet/public-resources/org.flowerplatform.web/org.flowerplatform.web.swc|library.swf'),
				setDescriptorWithUrl(new GitCommonPlugin(), 'servlet/public-resources/org.flowerplatform.web.git/org.flowerplatform.web.git.swc|library.swf')
			];
			
			private function startPlugins():void {
				for each (var plugin:AbstractFlexPlugin in plugins) {
					plugin.setupExtensionPointsAndExtensions();
				}
				for each (plugin in plugins) {
					plugin.start();
				}
			}
			
			protected function creationCompleteHandler():void {
				FlexUtilGlobals.getInstance().isMobile = true;	
				FlexUtilGlobals.getInstance().popupHandlerFactory = new WrapperViewPopupHandlerFactory();
				
				FlowerLoaderUtil._rootUrl = "http://localhost:8080/org.flowerplatform.web.app/";
				
				startPlugins();

				CommunicationPlugin.getInstance().bridge.addEventListener(BridgeEvent.WELCOME_RECEIVED_FROM_SERVER, welcomeReceivedFromServerHandler);
			}
			
			protected function welcomeReceivedFromServerHandler(event:BridgeEvent):void {
				viewNavigator.pushView(SplitView);
			}
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<mobile:MainNavigatorContent id="mainNavigatorContent" navigator="{viewNavigator}"/>
		<s:CrossFadeViewTransition id="crossFadeTransition"/>
	</fx:Declarations>
	<s:ViewNavigator id="viewNavigator" width="100%" height="100%" firstView="org.flowerplatform.web.mobile.RecentActivityView"
					 navigationContent="{mainNavigatorContent.navigatorContent}" defaultPushTransition="{crossFadeTransition}" defaultPopTransition="{crossFadeTransition}">
	</s:ViewNavigator>
</s:Application>
