<?xml version="1.0" encoding="utf-8"?>
<mx:HBox xmlns:mx="http://www.adobe.com/2006/mxml" xmlns:flexdiagram="com.crispico.flower.flexdiagram.*" addedToStage="creationCompleteHandler()" xmlns:common="com.crispico.flower.flexdiagram.util.common.*">
	<mx:Script>
		<![CDATA[
			import com.crispico.flower.flexdiagram.samples.basic.editpart.Viewer;
			import com.crispico.flower.flexdiagram.samples.basic.model.BasicConnection;
			import com.crispico.flower.flexdiagram.samples.basic.model.BasicModel;
			
			import mx.collections.ArrayCollection;
			import mx.events.CollectionEvent;

			private var rootModel:ArrayCollection = new ArrayCollection();
			
			private var viewer:Viewer;
			
			[Bindable]
			private var selectedModel:BasicModel;
			
			private function populateRootModel():void {
				var model:BasicModel;
				
				model = new BasicModel();
				model.name = "Model1";
				model.x = 10;
				model.y = 10;
				model.width = 100;
				model.height = 100;
				rootModel.addItem(model);

				model = new BasicModel();
				model.name = "Model2";
				model.x = 220;
				model.y = 220;
				model.width = 100;
				model.height = 100;
				rootModel.addItem(model);
				
				var connection:BasicConnection;
				
				connection = new BasicConnection();
				connection.source = rootModel[0];
				connection.target = rootModel[1];
				rootModel.addItem(connection);
			}
			
			private function creationCompleteHandler():void {
				populateRootModel();
				viewer = new Viewer(rootFigure, rootModel);
				viewer.getSelectedElements().addEventListener(CollectionEvent.COLLECTION_CHANGE, selectionChangeHandler);
				selectionChangeHandler(null);
			}
			
			private function selectionChangeHandler(event:Event):void {
				if (viewer.getSelectedElements().length == 0) {
					deleteButton.enabled = false;
					selectionLabel.text = "No selection";
					selectedModel = null;
				} else {
					deleteButton.enabled = true;
					selectionLabel.text = viewer.getSelectedElements().length + " selected elem(s)";
					if (viewer.getSelectedElements().length == 1 && viewer.getSelectedElements()[0].getModel() is BasicModel) {
						selectedModel = viewer.getSelectedElements()[0].getModel();
					} else {
						selectedModel = null;
					}
				}
			}
			
		]]>
	</mx:Script>
	
	<mx:Binding source="modelName.text" destination="selectedModel.name"/>
	<mx:Binding source="parseInt(modelX.text)" destination="selectedModel.x"/>
	<mx:Binding source="parseInt(modelY.text)" destination="selectedModel.y"/>
	<mx:Binding source="parseInt(modelWidth.text)" destination="selectedModel.width"/>
	<mx:Binding source="parseInt(modelHeight.text)" destination="selectedModel.height"/>
	
	<mx:Panel width="200" height="100%" title="Selection">
		<mx:VBox width="100%">
			<mx:Label id="selectionLabel"/>
			<mx:Form width="100%" enabled="{selectedModel != null}">
				<mx:FormItem label="Name" width="100%">
					<mx:TextInput id="modelName" width="100%" text="{selectedModel.name}"/>
				</mx:FormItem>
				<mx:FormItem label="X" width="100%">
					<mx:TextInput id="modelX" width="100%" text="{selectedModel.x}"/>
				</mx:FormItem>
				<mx:FormItem label="Y" width="100%">
					<mx:TextInput id="modelY" width="100%" text="{selectedModel.y}"/>
				</mx:FormItem>
				<mx:FormItem label="Width" width="100%">
					<mx:TextInput id="modelWidth" width="100%" text="{selectedModel.width}"/>
				</mx:FormItem>
				<mx:FormItem label="Height" width="100%">
					<mx:TextInput id="modelHeight" width="100%" text="{selectedModel.height}"/>
				</mx:FormItem>
			</mx:Form>
			<mx:Button label="Add">
				<mx:click>
					<![CDATA[
					var model:BasicModel = new BasicModel();
					model.width = model.height = 10;
					rootModel.addItem(model);
					
					viewer.addToSelection(viewer.getModelToEditPartMap()[model], true);
					]]>
				</mx:click>
			</mx:Button>
			<mx:Button id="deleteButton" label="Delete">
				<mx:click>
					<![CDATA[
						for (var i:int = viewer.getSelectedElements().length - 1; i >= 0; i--) {
							rootModel.removeItemAt(rootModel.getItemIndex(viewer.getSelectedElements()[i].getModel()));
						}
					]]>
				</mx:click>
			</mx:Button>
		</mx:VBox>
	</mx:Panel>
	<mx:Canvas width="100%" height="100%">
		<common:BitmapContainer source="../assets/map.png"/>
		<flexdiagram:RootFigure id="rootFigure" width="100%" height="100%" useGrid="false"/>
	</mx:Canvas>
</mx:HBox>
